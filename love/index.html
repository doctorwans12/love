<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>How Do You Talk to the Person You Like?</title>
    <link
      rel="icon"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1' y1='0' y2='1'%3E%3Cstop offset='0' stop-color='%23ff5a7a'/%3E%3Cstop offset='1' stop-color='%23e11d48'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='64' height='64' rx='16' fill='%23ffffff'/%3E%3Cpath fill='url(%23g)' d='M20 26c0-7 5.7-12.5 12.6-12.5 4.2 0 8.1 2 10.4 5.1 2.3-3.1 6.2-5.1 10.4-5.1C60.3 13.5 66 19 66 26c0 8.7-7.9 15.6-23 26.7-1.5 1.1-3.6 1.1-5.1 0C22.9 41.6 15 34.7 15 26z'/%3E%3Cpath fill='url(%23g)' d='M29 48l-9 6 3-10'/%3E%3Ccircle cx='29' cy='30' r='3.2' fill='%23ffffff'/%3E%3Ccircle cx='37' cy='30' r='3.2' fill='%23ffffff'/%3E%3Ccircle cx='45' cy='30' r='3.2' fill='%23ffffff'/%3E%3C/svg%3E"
    />
    <style>
      :root { color-scheme: light; }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        background: radial-gradient(circle at top, rgba(236, 72, 153, 0.25), rgba(15, 23, 42, 0.96));
        color: #f8fafc;
        min-height: 100vh;
      }
      .container { max-width: 900px; margin: 0 auto; padding: 48px 24px; }
      .card { background: rgba(15, 23, 42, 0.85); border-radius: 24px; padding: 32px; box-shadow: 0 20px 40px rgba(15, 23, 42, 0.45); }
      .badge { text-transform: uppercase; letter-spacing: 0.3em; font-size: 12px; color: #f9a8d4; }
      h1, h2, h3 { margin: 0 0 12px; }
      p { color: #cbd5f5; line-height: 1.6; }
      .primary { background: #ec4899; color: white; border: none; padding: 14px 26px; border-radius: 999px; font-weight: 600; font-size: 16px; cursor: pointer; }
      .primary:disabled { opacity: 0.6; cursor: not-allowed; }
      .secondary { background: transparent; border: 1px solid #475569; color: #e2e8f0; padding: 12px 22px; border-radius: 999px; cursor: pointer; }
      .option { width: 100%; text-align: left; background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; color: #f8fafc; padding: 14px 18px; border-radius: 18px; margin-bottom: 12px; cursor: pointer; }
      .option.selected { border-color: #f472b6; background: rgba(236, 72, 153, 0.2); }
      .row { display: flex; flex-wrap: wrap; gap: 16px; align-items: center; }
      .space-between { justify-content: space-between; }
      .hidden { display: none; }
      .progress { height: 8px; width: 100%; background: #1f2937; border-radius: 999px; overflow: hidden; }
      .progress span { display: block; height: 100%; background: #ec4899; width: 0; transition: width 0.3s ease; }
      ul { padding-left: 18px; }
      .error { color: #fca5a5; font-size: 14px; }
      .muted { color: #94a3b8; font-size: 14px; }
      .grid { display: grid; gap: 16px; }
      @media (min-width: 720px) { .grid-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="landing" class="card">
        <div class="row" style="align-items:center;gap:12px;margin-bottom:12px;">
          <img
            src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 240 240'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1' y1='0' y2='1'%3E%3Cstop offset='0' stop-color='%23ff5a7a'/%3E%3Cstop offset='1' stop-color='%23e11d48'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='240' height='240' rx='48' fill='%23ffffff'/%3E%3Cpath fill='url(%23g)' d='M66 92c0-25 20-45 45-45 18 0 33 8 41 21 8-13 23-21 41-21 25 0 45 20 45 45 0 32-28 57-80 95-7 5-16 5-23 0-52-38-80-63-80-95z'/%3E%3Cpath fill='url(%23g)' d='M94 180l-22 14 7-24'/%3E%3Ccircle cx='104' cy='114' r='10' fill='%23ffffff'/%3E%3Ccircle cx='130' cy='114' r='10' fill='%23ffffff'/%3E%3Ccircle cx='156' cy='114' r='10' fill='%23ffffff'/%3E%3Ccircle cx='184' cy='72' r='24' fill='%23ff5a7a'/%3E%3C/svg%3E"
            alt="How Do You Talk logo"
            style="width:56px;height:56px;border-radius:14px;background:#fff;"
          />
          <div>
            <p class="badge" style="margin-bottom:6px;">Dating & social skills test</p>
            <h1 style="margin:0;">How Do You Talk to the Person You Like?</h1>
          </div>
        </div>
        <p>
          People are becoming less social in real life. This quick test helps you understand your communication style
          in dating, so you can become more confident, clear, and consistent.
        </p>
        <button class="primary" id="startBtn">Start the test</button>
      </div>

      <div id="test" class="card hidden">
        <p class="badge">Dating & social skills test</p>
        <h1>How Do You Talk to the Person You Like?</h1>
        <p class="muted">Answer 15 quick questions to reveal your communication style before you unlock results.</p>
        <div class="progress"><span id="progressBar"></span></div>
        <p class="badge" id="progressText">Question 1 / 15</p>
        <h2 id="questionPrompt"></h2>
        <div id="options"></div>
        <p id="questionError" class="error hidden">Please select an answer to continue.</p>
        <div class="row space-between">
          <button class="secondary" id="backBtn">Back</button>
          <button class="primary" id="nextBtn">Next</button>
        </div>
      </div>

      <div id="paywall" class="card hidden">
        <p class="badge">Almost done</p>
        <h2>Your results are ready to unlock.</h2>
        <p>We prepared your communication archetype, trait scores, and advice. Unlock the full breakdown below.</p>
        <p id="payError" class="error hidden"></p>
        <div class="row">
          <button class="primary" id="payBtn">See the results</button>
          <button class="secondary" id="reviewBtn">Back to review</button>
        </div>
      </div>

      <div id="results" class="card hidden">
        <p class="badge">Your results</p>
        <h2 id="archetypeName"></h2>
        <p id="archetypeDescription"></p>
        <div class="grid grid-2">
          <div>
            <h3>Trait scores</h3>
            <ul id="traitList"></ul>
          </div>
          <div>
            <h3>What this means</h3>
            <p class="muted">Your archetype reflects how you show up in dating conversations and where you can grow.</p>
          </div>
        </div>
        <button class="primary" id="continueBtn">Continue</button>
      </div>

      <div id="advice" class="card hidden">
        <p class="badge">Personalized advice</p>
        <h2>Practical ways to level up</h2>
        <p id="adviceText">Loading advice...</p>
      </div>
    </div>

    <script>
      const questions = [
        { id: "q1", prompt: "When you want to start a conversation, you usually…", type: "choice", options: ["Go for it", "Overthink it", "Wait for a story", "Send something playful"] },
        { id: "q2", prompt: "If someone leaves you on seen, you…", type: "choice", options: ["Follow up once", "Assume they lost interest", "Make a joke", "Match their energy"] },
        { id: "q3", prompt: "How comfortable are you flirting directly?", type: "scale" },
        { id: "q4", prompt: "Your confidence in person is…", type: "scale" },
        { id: "q5", prompt: "You worry about saying the wrong thing…", type: "scale" },
        { id: "q6", prompt: "Your humor in dating is best described as…", type: "choice", options: ["Playful", "Thoughtful", "Dry", "I hold back"] },
        { id: "q7", prompt: "Emotional openness early on feels…", type: "scale" },
        { id: "q8", prompt: "Consistency in texting is…", type: "choice", options: ["Easy for me", "Hard when I'm anxious", "I reply in bursts", "I prefer real life"] },
        { id: "q9", prompt: "Setting boundaries feels…", type: "scale" },
        { id: "q10", prompt: "Texting vs real life: you feel…", type: "choice", options: ["Texting is easier", "Real life is easier", "Both are fine", "Depends on the person"] },
        { id: "q11", prompt: "How playful are you when flirting?", type: "scale" },
        { id: "q12", prompt: "When someone is slow to reply, you think…", type: "choice", options: ["They're busy", "I messed up", "I'll keep it light", "I'll match their pace"] },
        { id: "q13", prompt: "Complimenting someone you like feels…", type: "scale" },
        { id: "q14", prompt: "How likely are you to follow up after a great date?", type: "scale" },
        { id: "q15", prompt: "Your biggest goal in dating conversations is…", type: "choice", options: ["Clarity", "Comfort", "Fun", "Stability"] }
      ];

      const state = { currentIndex: 0, answers: {} };

      const landing = document.getElementById("landing");
      const test = document.getElementById("test");
      const paywall = document.getElementById("paywall");
      const results = document.getElementById("results");
      const advice = document.getElementById("advice");

      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");
      const questionPrompt = document.getElementById("questionPrompt");
      const optionsContainer = document.getElementById("options");
      const questionError = document.getElementById("questionError");

      const payError = document.getElementById("payError");
      const archetypeName = document.getElementById("archetypeName");
      const archetypeDescription = document.getElementById("archetypeDescription");
      const traitList = document.getElementById("traitList");
      const adviceText = document.getElementById("adviceText");

      document.getElementById("startBtn").addEventListener("click", () => {
        landing.classList.add("hidden");
        test.classList.remove("hidden");
        renderQuestion();
      });

      document.getElementById("backBtn").addEventListener("click", () => {
        if (state.currentIndex === 0) {
          test.classList.add("hidden");
          landing.classList.remove("hidden");
          return;
        }
        state.currentIndex -= 1;
        renderQuestion();
      });

      document.getElementById("nextBtn").addEventListener("click", () => {
        const currentQuestion = questions[state.currentIndex];
        if (state.answers[currentQuestion.id] === undefined) {
          questionError.classList.remove("hidden");
          return;
        }
        questionError.classList.add("hidden");

        if (state.currentIndex === questions.length - 1) {
          test.classList.add("hidden");
          paywall.classList.remove("hidden");
          return;
        }

        state.currentIndex += 1;
        renderQuestion();
      });

      document.getElementById("reviewBtn").addEventListener("click", () => {
        paywall.classList.add("hidden");
        test.classList.remove("hidden");
        renderQuestion();
      });

      document.getElementById("payBtn").addEventListener("click", async () => {
        payError.classList.add("hidden");
        try {
          const response = await fetch("/create-checkout-session", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ answers: state.answers })
          });
          if (!response.ok) throw new Error(await response.text());
          const data = await response.json();
          window.location.href = data.url;
        } catch {
          payError.textContent = "Unable to start checkout. Please try again.";
          payError.classList.remove("hidden");
        }
      });

      document.getElementById("continueBtn").addEventListener("click", async () => {
        results.classList.add("hidden");
        advice.classList.remove("hidden");
        await loadAdvice();
      });

      function renderQuestion() {
        const currentQuestion = questions[state.currentIndex];
        const answered = Object.keys(state.answers).length;
        const progress = Math.round((answered / questions.length) * 100);
        progressBar.style.width = `${progress}%`;
        progressText.textContent = `Question ${state.currentIndex + 1} / ${questions.length}`;
        questionPrompt.textContent = currentQuestion.prompt;
        optionsContainer.innerHTML = "";

        const options =
          currentQuestion.type === "scale" ? ["1", "2", "3", "4", "5"] : currentQuestion.options;

        options.forEach((option, index) => {
          const button = document.createElement("button");
          button.className = "option";
          button.textContent = option;
          if (state.answers[currentQuestion.id] === index) button.classList.add("selected");
          button.addEventListener("click", () => {
            state.answers[currentQuestion.id] = index;
            renderQuestion();
          });
          optionsContainer.appendChild(button);
        });
      }

      async function checkSessionFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const sessionId = params.get("session_id");
        const canceled = params.get("canceled");
        if (!sessionId) {
          landing.classList.remove("hidden");
          test.classList.add("hidden");
          renderQuestion();
          if (canceled) alert("Checkout was canceled. You can continue the test or try again.");
          return;
        }

        try {
          const response = await fetch(`/verify-session?session_id=${sessionId}`);
          if (!response.ok) throw new Error(await response.text());
          const data = await response.json();
          if (!data.paid) throw new Error("Payment not completed.");
          showResults(data.archetype, data.description, data.traits);
        } catch {
          landing.classList.remove("hidden");
          paywall.classList.add("hidden");
          test.classList.add("hidden");
          results.classList.add("hidden");
          advice.classList.add("hidden");
          alert("Payment not completed yet. Please finish checkout.");
        }
      }

      function showResults(archetype, description, traits) {
        landing.classList.add("hidden");
        test.classList.add("hidden");
        paywall.classList.add("hidden");
        results.classList.remove("hidden");

        archetypeName.textContent = archetype.name;
        archetypeDescription.textContent = description || "";
        traitList.innerHTML = "";

        Object.entries(traits).forEach(([key, value]) => {
          const li = document.createElement("li");
          li.textContent = `${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}`;
          traitList.appendChild(li);
        });
      }

      async function loadAdvice() {
        adviceText.textContent = "Loading advice...";
        try {
          const response = await fetch("/generate-advice", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              archetype: { name: archetypeName.textContent, description: archetypeDescription.textContent },
              traits: Object.fromEntries(
                Array.from(traitList.children).map((item) => {
                  const [name, score] = item.textContent.split(": ");
                  return [name.toLowerCase(), Number(score)];
                })
              )
            })
          });
          if (!response.ok) throw new Error(await response.text());
          const data = await response.json();
          adviceText.textContent = data.advice;
        } catch {
          adviceText.textContent = "Unable to load advice right now. Please try again.";
        }
      }

      checkSessionFromUrl();
    </script>
  </body>
</html>

